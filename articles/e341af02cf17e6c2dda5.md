---
title: "Remix + Cloudflare Pages + D1 ã®æœ€åˆã®ä¸€æ­©ç›®"
emoji: "ğŸ™"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [remix, cloudflarepages]
published: true
---

æœ€è¿‘ Cloudflare ã®ã‚µãƒ¼ãƒ“ã‚¹ã‚’è€³ã«ã™ã‚‹ã“ã¨ãŒå¢—ãˆã¾ã—ãŸã€‚
ãã®ä¸­ã§ Clouflare D1 ã«ç‰¹ã«èˆˆå‘³ã‚’æŒã£ãŸã®ã§è»½ãè§¦ã£ã¦ã¿ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

ä»Šå›ã¯ä½¿ã£ã¦ã¿ãŸã‹ã£ãŸ Remix ã¨åˆã‚ã›ã¦ã€ Remix + Cloudflare Pages + D1 ã®æœ€åˆã®ä¸€æ­©ç›®ã‚’ç´¹ä»‹ã§ãã‚Œã°ã¨æ€ã„ã¾ã™ã€‚

æœ¬å½“ã«è»½ãã—ã‹è§¦ã‚Œã¦ã¾ã›ã‚“ãŒã€ä½œã£ãŸã‚‚ã®ã¯ä¸‹è¨˜ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚ã‚Šã¾ã™ã€‚
https://github.com/creamstew/remix-cloudflare-pages-d1

## æº–å‚™

æœ€åˆã«ä¸‹è¨˜ 2 ã¤ã®æº–å‚™ãŒå¿…è¦ã§ã™ã€‚

- Cloudflare ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å–å¾—ã™ã‚‹
- Cloudflare Workers ç­‰ã® CLI ãƒ„ãƒ¼ãƒ«ã§ã‚ã‚‹ Wrangler ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãŠã

Cloudflare ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ä¸‹è¨˜ã‹ã‚‰å–å¾—ã—ã¾ã—ã‚‡ã†ã€‚
https://www.cloudflare.com/ja-jp/

Wrangler ã¯ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã§ãã¾ã™ã€‚

```bash
npm install -g wrangler
```

## Remix ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ

ä¸‹è¨˜ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚

```bash
npx create-remix@latest
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåã‚’å…¥åŠ›ã™ã‚‹ã¨ã€ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ã‚’é¸æŠã™ã‚‹ã‚ˆã†ä¿ƒã•ã‚Œã¾ã™ã€‚
Cloudflare Pages ã‚’é¸æŠã—ã¾ã—ã‚‡ã†ï¼

```bash
$ cd <YOUR_PROJECT>
npm run dev
```

ã§ http://127.0.0.1:8788 ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä¸‹è¨˜ã®ç”»é¢ãŒå‡ºã‚‹ã¨æ€ã„ã¾ã™ã€‚

![](/images/e341af02cf17e6c2dda5/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202023-04-29%20001641.png)

ã“ã‚Œã§ Remix ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆä½œæˆå®Œäº†ã§ã™ã€‚

ã“ã“ã¾ã§ã®æµã‚Œã‚„ Cloudflare Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ãªã©ã‚‚ä¸‹è¨˜ã«è¼‰ã£ã¦ã‚‹ã®ã§ã“ã¡ã‚‰ã‚’è¦‹ã¦ãã ã•ã„ã€‚
https://developers.cloudflare.com/pages/framework-guides/deploy-a-remix-site/

## Cloudflare D1 ã®ä½œæˆ ~ ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°

D1 ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã®ã¯ç°¡å˜ã§ã™ã€‚

```bash
wrangler d1 create <DATABASE_NAME>
```

ã“ã‚Œã ã‘ã§ã™ã€‚ã“ã‚Œã§ãƒ­ãƒ¼ã‚«ãƒ«ã« D1 ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒã§ãã¾ã™ã€‚

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹ã¨ã€Worker ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹ wrangler.toml ã«ä¸‹è¨˜ã®è¨­å®šãŒè¿½åŠ ã•ã‚Œã‚‹ã¯ãšã§ã™ã€‚

```toml:wrangler.toml
[[ d1_databases ]]
binding = "DB" # i.e. available in your Worker on env.DB
database_name = "<DATABASE_NAME>"
database_id = "<UUID>"
```

ã“ã®è¨­å®šã§ D1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ Worker ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°(é€£æº)ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚
https://developers.cloudflare.com/workers/platform/bindings/

## ã‚¯ã‚¨ãƒªå®Ÿè¡Œ

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½œã£ãŸã®ã§æ¬¡ã¯ãƒ†ãƒ¼ãƒ–ãƒ«ã¨ãƒ‡ãƒ¼ã‚¿ã‚’å°‘ã—ä½œæˆã—ã¾ã™ã€‚
Remix ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç›´ä¸‹ã« schema.sql ã¨ã„ã†ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Šã¾ã™ã€‚

```sql:schema.sql
DROP TABLE IF EXISTS Customers;
CREATE TABLE Customers (CustomerID INT, CompanyName TEXT, ContactName TEXT, PRIMARY KEY (`CustomerID`));
INSERT INTO Customers (CustomerID, CompanyName, ContactName) VALUES (1, 'Alfreds Futterkiste', 'Maria Anders'), (4, 'Around the Horn', 'Thomas Hardy'), (11, 'Bs Beverages', 'Victoria Ashworth'), (13, 'Bs Beverages', 'Random Name');
```

ä½œæˆã—ãŸ sql ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã§å®Ÿè¡Œã—ã¾ã™ã€‚

```bash
wrangler d1 execute <DATABASE_NAME> --local --file=./schema.sql
```

ã¡ã‚ƒã‚“ã¨å®Ÿè¡Œã§ãã¦ã„ã‚Œã°ã€ä¸‹è¨˜ã®ã‚ˆã†ãª SELECT æ–‡ã‚’æŠ•ã’ã¦ã¿ã‚‹ã¨çµæœãŒè¿”ã£ã¦ãã¾ã™ã€‚

```bash
wrangler d1 execute <DATABASE_NAME> --local --command='SELECT * FROM Customers'

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CustomerID â”‚ CompanyName         â”‚ ContactName       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1          â”‚ Alfreds Futterkiste â”‚ Maria Anders      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4          â”‚ Around the Horn     â”‚ Thomas Hardy      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 11         â”‚ Bs Beverages        â”‚ Victoria Ashworth â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 13         â”‚ Bs Beverages        â”‚ Random Name       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

```

## Remix ã§ãƒ‡ãƒ¼ã‚¿è¡¨ç¤º

ã‚¯ã‚¨ãƒªãŒå®Ÿè¡Œã§ãã‚‹ã“ã¨ã‚’ç¢ºèªã§ããŸã®ã§ã€Remix ã§ D1 ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã—ã¦ã„ãã¾ã™ã€‚
ã¾ãš package.json ã®è¨­å®šã‚’ä¸€éƒ¨æ›¸ãæ›ãˆã¾ã™ã€‚

```diff json:package.json
< wrangler pages dev ./public
---
> wrangler pages dev ./public --local --persist
```

persist ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ä»˜ã‘ã‚‹ã“ã¨ã§ .wrangler/state ã‚µãƒ–ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ãƒ‡ãƒ¼ã‚¿ãŒæ°¸ç¶šåŒ–ã•ã‚Œã¾ã™ã€‚

æ¬¡ã« Remix ã® routes/\_index.tsx ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†ã—ã¾ã™ã€‚

å¤‰æ›´å‰ã¯ã“ã®ã‚ˆã†ã«ãªã£ã¦ã‚‹ã¯ãšã§ã™ã€‚

```tsx:routes/_index.tsx
import type { V2_MetaFunction } from "@remix-run/react";

export const meta: V2_MetaFunction = () => {
  return [{ title: "New Remix App" }];
};

export default function Index() {
  return (
    <div style={{ fontFamily: "system-ui, sans-serif", lineHeight: "1.4" }}>
      <h1>Welcome to Remix</h1>
      <ul>
        <li>
          <a
            target="_blank"
            href="https://remix.run/tutorials/blog"
            rel="noreferrer"
          >
            15m Quickstart Blog Tutorial
          </a>
        </li>
        <li>
          <a
            target="_blank"
            href="https://remix.run/tutorials/jokes"
            rel="noreferrer"
          >
            Deep Dive Jokes App Tutorial
          </a>
        </li>
        <li>
          <a target="_blank" href="https://remix.run/docs" rel="noreferrer">
            Remix Docs
          </a>
        </li>
      </ul>
    </div>
  );
}
```

ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸‹è¨˜ã®ã‚ˆã†ã«ç·¨é›†ã—ã¾ã™ã€‚

```tsx:routes/_index.tsx
import type { LoaderArgs } from "@remix-run/cloudflare";
import { json } from "@remix-run/cloudflare";
import { useLoaderData } from "@remix-run/react";

type Customer = {
  CustomerID: number;
  CompanyName: string;
  ContactName: string;
};

export const loader = async ({ context }: LoaderArgs) => {
  const db = context.DB as D1Database;

  const { results } = await db
    .prepare("SELECT * FROM Customers")
    .all<Customer>();

  return json({
    customers: results ?? [],
  });
};

export default function Index() {
  const { customers } = useLoaderData<typeof loader>();

  return (
    <div style={{ fontFamily: "system-ui, sans-serif", lineHeight: "1.4" }}>
      <h1>Welcome to Remix</h1>
      <ul>
        {customers.map((customer) => (
          <li key={customer.CustomerID}>
            {customer.CompanyName}, {customer.ContactName}
          </li>
        ))}
      </ul>
    </div>
  );
}
```

ç·¨é›†å¾Œã«

```bash
npm run dev
```

ã§ã‚‚ã†ä¸€åº¦ http://127.0.0.1:8788 ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ä¸‹è¨˜ã®ç”»é¢ãŒå‡ºã‚‹ã¨æ€ã„ã¾ã™ã€‚

![](/images/e341af02cf17e6c2dda5/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202023-04-29%20003025.png)

D1 ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤ºå‡ºæ¥ã¦ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã¯ãšã§ã™ã€‚

ç·¨é›†å¾Œã®ã‚³ãƒ¼ãƒ‰ã«é–¢ã—ã¦è»½ãèª¬æ˜ã—ã¦ãŠãã¾ã™ã€‚

```ts
type Customer = {
  CustomerID: number;
  CompanyName: string;
  ContactName: string;
};
```

ã¯ã€sql ã‚’å®Ÿè¡Œã—ã¦ä½œæˆã—ãŸãƒ†ãƒ¼ãƒ–ãƒ«ã®å†…å®¹ã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚

```ts
export const loader = async ({ context }: LoaderArgs) => {
  const db = context.DB as D1Database;

  const { results } = await db
    .prepare("SELECT * FROM Customers")
    .all<Customer>();

  return json({
    customers: results ?? [],
  });
};
```

loader ã§ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚
context ã‹ã‚‰

```toml:wrangler.toml
[[ d1_databases ]]
binding = "DB" # i.e. available in your Worker on env.DB
database_name = "${DATABASE_NAME}"
database_id = "${DATABASE_ID}"
```

ã® DB ã«ç›´æ¥ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ã€‚
ã‚ã¨ã¯ sql ã§ ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ map ã§å±•é–‹ã—ã¦ã‚‹ã ã‘ã§ã™ã­ï¼

ã“ã‚Œã§ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®æœ€åˆã®ä¸€æ­©ç›®ã¯çµ‚äº†ã§ã™ã€‚

## Cloudflare Pages ã§ã®é€£æº

ã“ã¡ã‚‰ã«ã¤ã„ã¦ã‚‚è»½ãè§¦ã‚Œã¦ãŠãã¾ã™ã€‚

Cloudflare Pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ–¹æ³•ã¯ä¸‹è¨˜ã‚’ã”è¦§ãã ã•ã„ã€‚
https://developers.cloudflare.com/pages/framework-guides/deploy-a-remix-site/

ã‚„ã‚‹ã“ã¨ã¯ã‚·ãƒ³ãƒ—ãƒ«ã§å…ˆã»ã©ãƒ­ãƒ¼ã‚«ãƒ«ã§æµã—ãŸ sql ã‚’æœ¬ç•ªç’°å¢ƒã§ã‚‚æµã—ã¾ã™ã€‚

```bash
wrangler d1 execute <DATABASE_NAME> --file=./schema.sql
```

æœ¬ç•ªç’°å¢ƒã« sql æµã›ã¦ã‚‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚

```bash
wrangler d1 execute <DATABASE_NAME> --command='SELECT * FROM Customers'
```

ç¢ºèªã§ããŸã‚‰ã€Cloudflare Pages > è¨­å®š > Functions ã‚’é–‹ãå¤‰æ•°å DB ã«ä½œæˆã—ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é¸æŠã—ãŸã‚‰ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°å®Œäº†ã§ã™ã€‚

![](/images/e341af02cf17e6c2dda5/%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%BC%E3%83%B3%E3%82%B7%E3%83%A7%E3%83%83%E3%83%88%202023-04-29%20080622.png)

ã“ã‚Œã§ Cloudflare Pages ã§ã‚‚ D1 ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤ºã§ãã¦ã„ã‚‹ã¯ãšã§ã™ã€‚

æœ€å¾Œã«è£œè¶³ã¨ã—ã¦ã€

wrangler.toml ã¯ .gitignore ã«å«ã¾ã‚Œã¦ã¾ã›ã‚“ã€‚
ãã®ãŸã‚ database_name ã‚„ database_id ãªã©ã®æƒ…å ±ãŒãã®ã¾ã¾ã ã¨ã‚€ãå‡ºã—ã«ãªã‚Šã¾ã™ã€‚

ãã®ã‚ˆã†ãªå ´åˆã¯ .dev.vars ã«ç’°å¢ƒå¤‰æ•°ã®æƒ…å ±ã‚’è¨˜è¼‰ã—ã¦ãã®ç’°å¢ƒå¤‰æ•°ã‚’ wrangler.toml å†…ã§å¼å±•é–‹ã•ã›ã‚‹ã¨ã€
ã‚»ã‚­ãƒ¥ã‚¢ãªæƒ…å ±ã‚’ãƒªãƒã‚¸ãƒˆãƒªã«å«ã¾ãšã«æ¸ˆã¿ã¾ã™ã€‚

```bash:.dev.vars
DATABASE_NAME = <DATABASE_NAME>
DATABASE_ID = <DATABASE_ID>
```

```toml:wrangler.toml
[[ d1_databases ]]
binding = "DB" # i.e. available in your Worker on env.DB
database_name = "${DATABASE_NAME}"
database_id = "${DATABASE_ID}"
```

https://developers.cloudflare.com/workers/platform/environment-variables/

ä»¥ä¸Šã«ãªã‚Šã¾ã™ã€‚
D1 æ„å¤–ã¨ç°¡å˜ã«è§¦ã‚Œã¾ã—ãŸã€‚ã¾ã ãƒ™ãƒ¼ã‚¿ç‰ˆã ã¨æ€ã„ã¾ã™ãŒã€D1 ã®ã“ã‚Œã‹ã‚‰ã«æœŸå¾…ã—ã¦ã¾ã™ï¼
