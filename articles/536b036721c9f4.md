---
title: "Cloudflare Workers + Honoã§SwitchBot APIã‹ã‚‰æ¸©æ¹¿åº¦è¨ˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å®šæœŸçš„ã«å–å¾—ã™ã‚‹"
emoji: "ğŸ’­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["switchbot", "hono", "cloudflareworkers"]
published: false
---

## ã‚„ã‚ŠãŸã„ã“ã¨

- SwitchBot API ã‹ã‚‰æ¸©æ¹¿åº¦è¨ˆã®ãƒ‡ãƒ¼ã‚¿ã‚’å®šæœŸçš„ã«å–å¾—ã—ã¦ DB ã«ä¿å­˜ã™ã‚‹
- ç„¡æ–™ã§å®Ÿè¡Œã™ã‚‹

## ãªãœ Cloudflare Workers ãªã®ã‹

ä»Šã¾ã§ç„¡æ–™ã§ç°¡å˜ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®šæœŸå®Ÿè¡Œã—ãŸã„å ´åˆã¯ Cloud Functions ãŒè‡ªåˆ†ã®ä¸­ã§ç¬¬ 1 å€™è£œã§ã—ãŸã€‚
ã¾ãŸã€ä¸Šè¨˜ã®è¦ä»¶ã‚’æº€ãŸã›ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã¯æœ€è¿‘ã ã¨ Vercel ã‚„ Supabase, Deno ãªã©ã®å„ç¨®ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãŒç”¨æ„ã™ã‚‹ Edge Functions ã§ã‚‚ååˆ†æº€ãŸã›ã‚‹ç¯„å›²ã ã¨æ€ã„ã¾ã™ã€‚
ãã®ä¸­ã§ Cloudflare Workers ã¯ä¸‹è¨˜ã® 2 ç‚¹ãŒåœ§å€’çš„ã ã£ãŸã‹ã‚‰ã§ã™ã€‚
åˆ¶é™ã¯ã‚ã‚Šã¾ã™ãŒã€ãã®ä¸­ã§æº€ãŸã›ã‚‹ã‚‚ã®ã«é–¢ã—ã¦ã¯æ¥µåŠ› Cloudflare Workers ã‚’ä½¿ç”¨ã—ã¦ã„ããŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚

- Cloudflare Workers ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒã¨ã«ã‹ãæ—©ã„
- ã™ãé–‹ç™ºç’°å¢ƒã‚’ç”¨æ„ã§ãã‚‹

## ã©ã®ã‚ˆã†ã«å®Ÿç¾ã—ãŸã‹

Cloudflare Workers ã«ã¯ Cron Triggers ã¨ã„ã†å®šæœŸå®Ÿè¡Œã™ã‚‹ãŸã‚ã®è¨­å®šãŒå¯èƒ½ã§ã™ã€‚
cron ã®è¨­å®šã‚„ãƒ†ã‚¹ãƒˆã‚‚ã¨ã¦ã‚‚æ¥½ã«ã§ãã¾ã™ã€‚
https://developers.cloudflare.com/workers/configuration/cron-triggers/

Cloudflare Workers ç”¨ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½œã‚‹éš›ã«ã¯ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã¨ã—ã¦ã„ã¤ã‚‚ Hono ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã™ã€‚ã‚ˆã‚Šç°¡å˜ã« Cloudflare Workers ã®ãƒªã‚½ãƒ¼ã‚¹ã‚’æ‰±ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã®ã§ã¨ã¦ã‚‚ä¾¿åˆ©ã§ã™ã€‚
https://hono.dev/getting-started/cloudflare-workers

SwitchBot API ã‚’ã—ãŸæ¸©æ¹¿åº¦è¨ˆãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«ã¤ã„ã¦ã¯ã™ã§ã«ã„ãã¤ã‚‚ã®è¨˜äº‹ãŒå‡ºã¦ã„ã‚‹ã®ã§è©³ã—ãè¨€åŠã—ã¾ã›ã‚“ã€‚

è‡ªåˆ†ãŒæ›¸ã„ãŸ Cloudflare Workers + Hono ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¸‹è¨˜ã«è¼‰ã›ã¦ãŠãã®ã§å‚è€ƒã«ã—ã¦ã¿ã¦ãã ã•ã„ã€‚

```ts:index.ts

import { PrismaClient } from "@prisma/client/edge";
import { withAccelerate } from "@prisma/extension-accelerate";
import { Hono } from "hono";

type Env = {
  SWITCH_BOT_TOKEN: string;
  SWITCH_BOT_SECRET: string;
  SWITCH_BOT_DEVICE_ID: string;
  DATABASE_URL: string;
};

type SwitchBotResponse = {
  statusCode: number;
  body: {
    deviceId: string;
    deviceType: string;
    hubDeviceId: string;
    humidity: number;
    temperature: number;
    version: string;
    battery: number;
  };
  message: string;
};

const app = new Hono<{ Bindings: Env }>();

async function generateSignature(token: string, secret: string) {
  const nonce = crypto.randomUUID(); // UUID v4ã‚’ç”Ÿæˆ
  const t = Date.now(); // ç¾åœ¨ã®ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ï¼ˆãƒŸãƒªç§’ï¼‰
  const stringToSign = `${token}${t}${nonce}`;
  const encoder = new TextEncoder();
  const secretEncoded = encoder.encode(secret);
  const stringToSignEncoded = encoder.encode(stringToSign);

  // HMAC-SHA256ç½²åã‚’ç”Ÿæˆ
  const key = await crypto.subtle.importKey(
    "raw",
    secretEncoded,
    { name: "HMAC", hash: "SHA-256" },
    false,
    ["sign"]
  );
  const signArrayBuffer = await crypto.subtle.sign(
    "HMAC",
    key,
    stringToSignEncoded
  );
  const sign = btoa(String.fromCharCode(...new Uint8Array(signArrayBuffer)));

  return { sign, t, nonce };
}

async function fetchFromSwitchBot(
  token: string,
  deviceId: string,
  sign: string,
  t: number,
  nonce: string
) {
  // SwitchBot APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
  const SWITCH_BOT_API_URL = `https://api.switch-bot.com/v1.1/devices/${deviceId}/status`;

  // APIãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¨­å®š
  const apiHeader = {
    Authorization: token,
    "Content-Type": "application/json",
    t: t.toString(),
    sign: sign,
    nonce: nonce,
  };

  // SwitchBot APIã‹ã‚‰ãƒ‡ãƒã‚¤ã‚¹ãƒªã‚¹ãƒˆã‚’å–å¾—
  const response = await fetch(SWITCH_BOT_API_URL, {
    headers: apiHeader,
  });
  const res: SwitchBotResponse = await response.json();

  return res;
}

async function insertIntoDatabase(
  databaseUrl: string,
  humidity: number,
  temperature: number
) {
  const prisma = new PrismaClient({
    datasourceUrl: databaseUrl,
  }).$extends(withAccelerate());

  try {
    await prisma.<table_name>.create({
      data: <data>,
    });
  } finally {
    await prisma.$disconnect();
  }
}

const scheduled: ExportedHandlerScheduledHandler<Env> = async (
  event,
  env,
  ctx
) => {
  const token = env.SWITCH_BOT_TOKEN;
  const secret = env.SWITCH_BOT_SECRET;
  const deviceId = env.SWITCH_BOT_DEVICE_ID;
  const databaseUrl = env.DATABASE_URL;

  const { sign, t, nonce } = await generateSignature(token, secret);
  const res = await fetchFromSwitchBot(token, deviceId, sign, t, nonce);
  await insertIntoDatabase(
    databaseUrl,
    res.body.humidity,
    res.body.temperature
  );
};

export default {
  fetch: app.fetch,
  scheduled,
};
```

ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é–¢é€£ã®è¨˜è¿°ã«é–¢ã—ã¦ã¯è‡ªèº«ãŒä½¿ç”¨ã—ãŸã„ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ˆã£ã¦é©å®œå¤‰æ›´ã—ã¦ãã ã•ã„ã€‚
è‡ªåˆ†ã¯ TiDB Serverless ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¦ã„ã¾ã™ã€‚

Cloudflare Workers ã‹ã‚‰ TiDB Serverless ã¸ã®æ¥ç¶šã«é–¢ã—ã¦ã¯ @tidbcloud/serverless ã‚’ä½¿ç”¨ã—ãŸæ–¹æ³•ãŒå…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã«ãƒªãƒ³ã‚¯ã¨ã—ã¦å¼µã‚‰ã‚Œã¦ã„ã¾ã™ã€‚
https://github.com/tidbcloud/serverless-js

ãŸã ã€ã¾ã  beta ç‰ˆã ã‹ã‚‰ãªã®ã‹ã“ã®æ–¹æ³•ã ã¨æœ¬ç•ªç’°å¢ƒã®ã¿ã§ãŸã¾ã«ã‚¨ãƒ©ãƒ¼ãŒå‡ºã¦ã—ã¾ã£ãŸã®ã§ Prisma ã§ã®æ¥ç¶šæ–¹æ³•ã«å¤‰æ›´ã—ã¦ã„ã¾ã™ã€‚
https://www.prisma.io/docs/orm/prisma-client/deployment/edge/deploy-to-cloudflare-workers

ä½•ã‹ã®å‚è€ƒã«ãªã‚Œã°å¹¸ã„ã§ã™ã€‚
