---
title: "Amplifyã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’Github Actionsã‚’ç”¨ã„ã¦æ—¥æ™‚ã§S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹"
emoji: "ğŸ•"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [amplify,githubactions]
published: false
---

## Amplifyã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã¯S3ã‚„CloudWatch Logsã¨ã®IntegrationãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ãªã„
Amplifyã¯ã¨ã¦ã‚‚ä¾¿åˆ©ãªã‚µãƒ¼ãƒ“ã‚¹ã§ã™ã€‚
ãªã®ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚‚ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã½ã¡ã½ã¡ã‚„ã£ãŸã‚‰ã™ãã«S3ã«è»¢é€ã•ã‚Œã‚‹ã‚ˆã†ã«ã§ãã‚‹ã¨æ€ã£ã¦ã„ãŸ...

ã§ããªã„ã§ã™ã€‚
https://docs.aws.amazon.com/amplify/latest/userguide/access-logs.html

ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’å–å¾—ã™ã‚‹æ–¹æ³•ã¯ã€ä¸‹è¨˜ã®2é€šã‚Š
 - ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
 - AWS CLIã‚’ç”¨ã„ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLã‚’ç”Ÿæˆã—ã¦ã€ãã“ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹

ã„ã¡ã„ã¡ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ã®ã¯ã‚ã‚“ã©ãã•ã„ã®ã§ã€å½“ç„¶AWS CLIã‚’ä½¿ã£ã¦è‡ªå‹•ã§S3ã«è»¢é€ã™ã‚‹ä»•çµ„ã¿ã‚’è€ƒãˆãŸã€‚

## è‡ªå‹•ã§ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’S3ã«è»¢é€ã—ãŸã„

æœ€åˆã¯ä¸‹è¨˜ã‚’å‚è€ƒã«`EventBridge`ã§ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ç™ºç«ã—ã¦`Lambda`ã§ã¨ã£ã¦ãã‚‹æ–¹æ³•ã‚’è€ƒãˆãŸã€‚
https://dev.classmethod.jp/articles/amplify-accesslog-to-s3/

ãŸã Lambdaã‚’ä½œã‚‹ã®ã‚‚ã¡ã‚‡ã£ã¨ã‚ã‚“ã©ãã•ã„ã€‚

AWS CLIã¨curlã§å–å¾—ã™ã‚‹æ–¹æ³•ç™ºè¦‹ã€‚ã‚¿ã‚¤ãƒˆãƒ«ã®é€šã‚Šã€ã“ã‚Œãªã‚‰ã‚µã‚¯ãƒƒã¨å–å¾—ã§ããã†ã€‚
https://zenn.dev/noid11/articles/6620e494816a4ea9b56b

ãªã‚‰Github Actionsã§æ—¥æ™‚ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å›ã›ã°ã„ã„ã‚“ã˜ã‚ƒã­ã€ã¨æ€ã„ä½œã£ãŸã®ãŒã“ã¡ã‚‰

```yml
name: ExportAccessLogsToS3

on:
  schedule
    - cron: '0 0 * * *'

env:
  TZ: UTC

permissions:
  id-token: write
  contents: read

jobs:
  ExportAccessLogsToS3:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: ${{ secrets.ROLE_TO_ASSUME }}

      - name: Generate Access logs & Export CSV & Upload S3
        run: |
          START_TIME=`date -d "1 days ago" "+%Y-%m-%dT00:00:00"`
          END_TIME=`date -d "1 days ago" "+%Y-%m-%dT23:59:59"`
          DOMAIN_NAME=xxx.amplifyapp.com
          aws amplify generate-access-logs --start-time $START_TIME --end-time $END_TIME --domain-name $DOMAIN_NAME --app-id ${{ secrets.AMPLIFY_APP_ID }} --query logUrl | xargs curl -o /tmp/filename.csv
          aws s3 cp /tmp/filename.csv s3://${{ secrets.S3_BUCKET_NAME }}
```

æ—¥æ™‚ã§æ˜¨æ—¥ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã‚’åé›†ã—ãŸCSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’s3ã«è»¢é€ã—ã¦ã„ã¾ã™ã€‚
Amplifyã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã¯UTCãªã®ã§æ³¨æ„ã€‚ï¼ˆãªã®ã§envã§UTCã‚’è¨­å®šã—ã¦ã€cronã‚‚UTCåŸºæº–ã®0æ™‚ã§å›ã—ã¦ã„ã¾ã™ï¼‰

ä½™è«‡ã§ã™ãŒã€æœ€è¿‘GitHub Actions ã« AWS ã‚¯ãƒ¬ãƒ‡ãƒ³ã‚·ãƒ£ãƒ«ã‚’ç›´æ¥æ¸¡ã•ãšã« IAM ãƒ­ãƒ¼ãƒ«ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã£ã¦ã¾ã—ãŸã€‚
https://docs.github.com/ja/actions/deployment/security-hardening-your-deployments/configuring-openid-connect-in-amazon-web-services

ã‚„ã‚Šæ–¹ã‚‚ãã‚“ãªã«é›£ã—ããªãã¦ã€æœ€é«˜ã§ã™ï¼

## å‚è€ƒ
 - https://zenn.dev/noid11/articles/6620e494816a4ea9b56b
 - https://awscli.amazonaws.com/v2/documentation/api/latest/reference/amplify/generate-access-logs.html
